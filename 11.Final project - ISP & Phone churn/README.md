# Создание модели, прогнозирующей отток клиентов
Оператор связи «Ниединогоразрыва.ком» хочет научиться прогнозировать отток клиентов. Если выяснится, что пользователь планирует уйти, ему будут предложены промокоды и специальные условия. Команда оператора собрала персональные данные о некоторых клиентах, информацию об их тарифах и договорах.
## Описание данных, полученное от внутреннего клиента

### О компании

Оператор предоставляет два основных типа услуг: 

1. Стационарную телефонную связь. Возможно подключение телефонного аппарата к нескольким линиям одновременно.
2. Интернет. Подключение может быть двух типов: через телефонную линию (DSL*,* от англ. *digital subscriber line*, «цифровая абонентская линия») или оптоволоконный кабель (*Fiber optic*).  

Также доступны такие услуги:

- Интернет-безопасность: антивирус (*DeviceProtection*) и блокировка небезопасных сайтов (*OnlineSecurity*);
- Выделенная линия технической поддержки (*TechSupport*);
- Облачное хранилище файлов для резервного копирования данных (*OnlineBackup*);
- Стриминговое телевидение (*StreamingTV*) и каталог фильмов (*StreamingMovies*).

За услуги клиенты могут платить каждый месяц или заключить договор на 1–2 года. Доступны различные способы расчёта и возможность получения электронного чека.

### Описание данных

Данные состоят из файлов, полученных из разных источников:

- `contract.csv` — информация о договоре;
- `personal.csv` — персональные данные клиента;
- `internet.csv` — информация об интернет-услугах;
- `phone.csv` — информация об услугах телефонии.

Во всех файлах столбец `customerID` содержит код клиента.

Информация о договорах актуальна на 1 февраля 2020.

### Цель исследования

Создать предиктивную модель, максимально точно определяющую клиентов, планирующих уйти. 

## План исследования

**- Исследовательский анализ данных и предобработка:**
  * Оценка полноты данных, работа с пропусками, дубликатами
  * Приведение столбцов к корректным типам данных
  * Определение наиболее значимых признаков
  * Оценка распределения клиентов по ключевым признакам
  * Определение ключевой метрики для сравнения моделей  
  
  
**- Подготовка признаков:**
  * Объединение таблиц
  * Устранение дисбаланса выборки (если понадобится)
  * Разделение на тренировочную и тестовую выборки
  * Стандартизация/нормализация числовых переменных
  * Кодирование категориальных переменных  
  
  
**- Выбор модели:**
  * Имплементация моделей (обучение и подбор гиперпараметров)
  * Сравнение результатов согласно выбранной метрике
  * Проверка результатов лучшей модели на тестовой выборке  


**- Описание итогов исследования**

## Отчёт о проделанной работе

### Исходная задача: 
Была поставлена задача создать модель, наиболее точно предсказывающую, что пользователь планирует уйти. Модель будут использовать для определения, предлагать ли пользователю более выгодные условия, чтобы удержать его.

### Исходные данные
Данные хранились в нескольких .csv-таблицах с общим полем customerID - уникальным идентификатором клиента.

### Шаги исследования
- Исследовательский анализ данных и предобработка  
- Подготовка признаков
- Обучение и отбор модели
- Тестирование модели

### Summary:
**- Исследовательский анализ данных и предобработка:**
  * Оценена полнота данных, устранены пропуски, дубликаты не обнаружены
  * Столбцы были приведены к корректным типам данных (datetime для дат). Бинарные категориальные признаки было решено не кодировать вручную и не приводить к типу bool. 
  * Были определены наиболее значимые признаки - срок обслуживания клиента, способ оплаты, ежемесячная сумма затрат
  * Были сравнены показатели ушедших и оставшихся клиентов - наибольшие различия обнаружены в разрезе услуги оптоволоконного интернет-доступа.
  * Были удалены нерелеватнтные признаки:
    - Признаки, не обладающие корреляцией с другими признаками.
    - Признаки, обладавшие мультиколлинеарностью с другими признаками.
  * Ключевой метрикой для сравнения моделей была выбрана AUC-ROC ***>0.85***.          
  
  Эта метрика оценивает насколько точно модель предсказывает оба класса (остался/ушёл) и сравнивает обученную модель с константной моделью.   
  
  
  * В качестве дополнительной метрики выбрана recall, полнота.   
  
  При возможной оптимизации recall было принято решение опираться на достаточно высокий f1-score: эта метрика, как и AUC-ROC, показывает, насколько точно модель предсказывает оба класса, но в отличие от неё, зависит от порогового значения вероятности для отнесения к положительному классу, которое можно менять, чтобы изменить предпочтения и склонности модели. 
  
  
**- Подготовка признаков:**
  * Таблицы были объединены, образовавшиеся пропуски заполнены. 
  * Устранение дисбаланса выборки признано необязательным: соотношение ушедших и оставшихся 3:1.
  * Данные были разделены на тренировочную и тестовую выборки
  * Были созданы преобразователи признаков для разных моделей:
    - Стандартизация/нормализация числовых переменных и OHE-кодирование категориальных переменных для линейных моделей
    - Порядковое кодирование категориальных переменных для моделей на основе деревьев решений (случайный лес, градиентный бустинг)
  
  
**- Выбор модели:**
  * Для исследования были выбраны следующие модели:
      - Стохастический градиентный спуск
      - Случайный лес
      - Градиентный бустинг из библиотеки `scikit-learn`
      - Градиентный бустинг `CatBoost` с встроенным кодировщиком категориальных признаков
  * Для первых трёх моделей были созданы пайплайны с соответствующими типу модели преобразователями.
  * Модели были обучены с Байесовским подбором гиперпараметров на кросс-валидации (`skopt-BayesSeachCV`).  
  Был задан критерий ранней остановки подбора - когда разница между результатами лучшей на данный момент моделью и исследуемой составляла не более ***0.002*** (AUC-ROC меняется в диапазоне от 0 до 1). 
  * Модели были сравнены по результатам обучения на тестовой выборке по основной метрике. Была выбрана модель `CatBoost` с гиперпараметрами:  
  `learning_rate': 0.15, 
  'n_estimators': 600, 
  'min_child_samples': 40`  
  Итоговый AUC-ROC на тренировочной выборке = ***0.911***
  * Для увеличения вторичной метрики была произведена оптимизация порога разнесения по классам с ограничением на допустимую общую неточность. 
  Итоговый recall на тестовой выборке = ***0.927***
  
  Сравнение метрик моделей:
  
  <div>
    <img align = left src="https://i.ibb.co/6JdwyK1/2023-04-12-17-59-30.png" width="450"/>
  <br><br><br><br><br><br><br>
  </div>
  * Модель была проверена на тестовой выборке 
    - Итоговый AUC-ROC на тренировочной выборке = ***0.872***  
    - Итоговый recall на тестовой выборке = ***0.808***    
    - Итоговая accuracy на тестовой выборке = ***0.870***   
  
  * Наиболее важные признаки для модели - длительность обслуживания абонента, ежемесячная сумма к оплате, тип контракта и тип интернет-подключения. 
 
  <div>
    <img align = left src="https://iili.io/HvePFkl.md.png" width="600"/>
  <br><br><br><br><br><br><br>
  
 ### Трудности:
 - Использовать ли ресэмплинг? Отказался, модели переобучались и завышали метрики на тестовой выборке
 - Максимизация пространства гиперпараметров для моделей при сохранении относительного быстродействия
 - Отбор признаков: оставить ли хотя бы один из числовых признаков, или отказаться от обоих? Оставил один, более информативный из двух
 - Ручное кодирование бинарных признаков и приведение их к булевому типу или использование энкодеров? Использовал энкодеры, соответствующие моделям.
 
 
